---
title: "Dendrogram"
output: html_document
date: "2026-02-11"
---

```{r}
```{r}
# ============================================================
# AA vs Structural tree comparison (tanglegram + cluster coloring)
# - LEFT tree: FoldMason structural guide tree (.nw)
# - RIGHT tree: IQ-TREE AA consensus tree (.contree)
# - Colors: derived from clusters cut on the LEFT dendrogram
# - Lines: colored by LEFT cluster membership
# - Branches: neutral gray
# ============================================================

library(ape)
library(phangorn)
library(dendextend)
library(viridisLite)

# ----------------------------
# #1 — Input files
# ----------------------------
tL_file <- "~/Downloads/lysB_structural.nw"
tR_file <- "~/Downloads/lysB_AA_ML.contree"

# ----------------------------
# #2 — Read trees
# ----------------------------
tL <- read.tree(tL_file)
tR <- read.tree(tR_file)

cat("Original tip counts:\n")
cat("  LEFT (struct):", length(tL$tip.label), "\n")
cat("  RIGHT (AA):  ", length(tR$tip.label), "\n")

# ----------------------------
# #3 — Keep only shared tips
# ----------------------------
shared <- intersect(tL$tip.label, tR$tip.label)

tL <- keep.tip(tL, shared)
tR <- keep.tip(tR, shared)

cat("Shared tips:", length(shared), "\n")
stopifnot(setequal(tL$tip.label, tR$tip.label))
tL <- midpoint(tL)
tR <- midpoint(tR)
# ----------------------------
# #4 — Resolve polytomies only if needed
# ----------------------------
if (!is.binary(tL)) tL <- multi2di(tL)
if (!is.binary(tR)) tR <- multi2di(tR)

tL <- ladderize(tL)
tR <- ladderize(tR)

# ----------------------------
# #5 — Convert phylo → dendrogram using cophenetic distances
# (avoids ultrametric requirement)
# ----------------------------
dL <- as.dendrogram(
  hclust(as.dist(cophenetic(tL)), method = "average")
)

dR <- as.dendrogram(
  hclust(as.dist(cophenetic(tR)), method = "average")
)

# ----------------------------
# #6 — Define clusters on LEFT using relative height
# ----------------------------
h_rel <- 0.25
maxh  <- attr(dL, "height")

clL <- cutree(dL, h = h_rel * maxh)

k   <- length(unique(clL))
pal <- setNames(viridis(k), sort(unique(clL)))

stopifnot(all(labels(dL) %in% names(clL)))
stopifnot(all(labels(dR) %in% names(clL)))

# ----------------------------
# #7 — Color tip labels by LEFT clusters
# ----------------------------
dL_col <- set(dL, "labels_col", pal[ clL[ labels(dL) ] ])
dR_col <- set(dR, "labels_col", pal[ clL[ labels(dR) ] ])

# Neutral branch styling
dL_col <- set(dL_col, "branches_col", "gray20")
dR_col <- set(dR_col, "branches_col", "gray20")

dL_col <- set(dL_col, "branches_lwd", 1)
dR_col <- set(dR_col, "branches_lwd", 1)

# ----------------------------
# #8 — Untangle to reduce crossings
# ----------------------------
set.seed(1)
unt <- untangle(dL_col, dR_col, method = "step2side")

dL_col <- unt[[1]]
dR_col <- unt[[2]]

# Color connecting lines by LEFT clusters
line_cols <- pal[ clL[ labels(dL_col) ] ]

# ----------------------------
# #9 — Plot tanglegram
# ----------------------------
png(
  filename = "~/Documents/AA_vs_Struct_tanglegram.png",
  width = 12,
  height = 9,
  units = "in",
  res = 300
)

tanglegram(
  dL_col,
  dR_col,
  lab.cex = 1,
  margin_inner = 5.3, #This changes the size of the names in the middle to the lines for better visualization 
  highlight_distinct_edges = FALSE,
  common_subtrees_color_lines = FALSE,
  lwd = 1,
  color_lines = line_cols
)

dev.off()

cat("Wrote: AA_vs_Struct_tanglegram.png\n")

# ----------------------------
# #10 — Tree comparison metrics
# ----------------------------

# Normalized Robinson–Foulds distance (topology only)
rf <- RF.dist(unroot(tL), unroot(tR), normalize = TRUE)

cat("Normalized RF distance:", rf, "\n")

# Entanglement metric
ent <- entanglement(dL_col, dR_col)

cat("Entanglement:", ent, "\n")

write.csv(
  data.frame(
    metric = c("Normalized_RF", "Entanglement"),
    value  = c(rf, ent)
  ),
  "~/Documents/AA_vs_Struct_tree_metrics.csv",
  row.names = FALSE
)

cat("Wrote: AA_vs_Struct_tree_metrics.csv\n")
```

